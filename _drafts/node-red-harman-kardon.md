---
layout: post
title: "Node-RED: Harman Kardon AVR"
categories: postitused
tags: node-red
image: node-red.png
---

```
    [{"id":"4fc5eb01.4c2574","type":"mqtt-broker","z":"5fbe740.7d8188c","broker":"localhost","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"/health/pi3","willQos":"1","willRetain":"false","willPayload":"bye","birthTopic":"/health/pi3","birthQos":"1","birthRetain":null,"birthPayload":"hello"},{"id":"b23704c3.90f118","type":"mqtt in","z":"5fbe740.7d8188c","name":"test","topic":"/test","broker":"4fc5eb01.4c2574","x":163,"y":204,"wires":[["bb278f0f.e8295"]]},{"id":"bb278f0f.e8295","type":"debug","z":"5fbe740.7d8188c","name":"","active":true,"console":"false","complete":"false","x":347,"y":217,"wires":[]},{"id":"b78aa103.be206","type":"debug","z":"5fbe740.7d8188c","name":"","active":true,"console":"false","complete":"req.params","x":504,"y":286,"wires":[]},{"id":"fd92ea36.a78e78","type":"inject","z":"5fbe740.7d8188c","name":"","topic":"","payload":"{\"cmd\": \"mute-toggle\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":229,"y":470,"wires":[["c5e22e31.75e75","ab75b9bf.c7ba68"]]},{"id":"c5e22e31.75e75","type":"function","z":"5fbe740.7d8188c","name":"","func":"\n   var payload = msg.payload;\n   var cmd = payload.cmd;\n   var zone = payload.zone || 'Main Zone';\n   var param = payload.param || '';\n   //var body = '<?xml version=\"1.0\" encoding=\"UTF-8\"?> <harman> <bds> <common> <control> <name>' + cmd + '</name> <zone>' + zone + '</zone> <para>' + param + '</para> </control> </common> </bds> </harman>';\n   var body = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\\n<harman>\\\n<bds>\\\n<common>\\\n<control>\\\n<name>' + cmd + '</name>\\\n<zone>' + zone + '</zone>\\\n<para>' + param + '</para>\\\n</control>\\\n</common>\\\n</bds>\\\n</harman>';\n   var text = 'POST HK_APP HTTP/1.1\\r\\n';\n   text += 'Host: :' + 10025 + '\\r\\n';\n   text += 'User-Agent: Harman Kardon BDS Remote Controller/1.0\\r\\n';\n   text += 'Content-Length: ' + body.length + '\\r\\n';\n   text += '\\r\\n';\n   text += body;\n   return { payload: text};","outputs":1,"noerr":0,"x":437,"y":514,"wires":[["ab75b9bf.c7ba68","44e58a44.7313e4"]]},{"id":"ab75b9bf.c7ba68","type":"debug","z":"5fbe740.7d8188c","name":"","active":true,"console":"false","complete":"false","x":636,"y":440,"wires":[]},{"id":"e91dd8a.b8e2128","type":"inject","z":"5fbe740.7d8188c","name":"","topic":"","payload":"{\"cmd\": \"source-select\", \"param\": \"AUX\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":174,"y":513,"wires":[["c5e22e31.75e75"]]},{"id":"a70df175.9fb07","type":"inject","z":"5fbe740.7d8188c","name":"","topic":"","payload":"{\"cmd\": \"volume-up\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":217,"y":585,"wires":[["c5e22e31.75e75"]]},{"id":"cf679622.8fbfa8","type":"inject","z":"5fbe740.7d8188c","name":"","topic":"","payload":"{\"cmd\": \"volume-down\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":212,"y":639,"wires":[["c5e22e31.75e75"]]},{"id":"44e58a44.7313e4","type":"tcp request","z":"5fbe740.7d8188c","server":"192.168.0.12","port":"10025","out":"char","splitc":"\\n","name":"","x":594,"y":650,"wires":[["ab75b9bf.c7ba68"]]},{"id":"30444dc4.17bbc2","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr/src/:src","method":"get","swaggerDoc":"","x":154,"y":298,"wires":[["de348885.5393a8"]]},{"id":"de348885.5393a8","type":"function","z":"5fbe740.7d8188c","name":"","func":"\nvar params = msg.req.params,\n  command = {};\n\nif (params.src) {\n    command.cmd = 'source-selection',\n    command.param = params.src;\n} else if (params.volume) {\n    command.cmd = 'volume-' + params.volume;\n    command.param = '10';\n} else if (params.mute) {\n    command.cmd = 'mute-' + params.mute;\n} else if (params.cmd) {\n    command.cmd = params.cmd;\n    if (params.param) {\n        command.param = params.param;\n    }\n}\n\n\n\nmsg.payload = 'OK';\n\nreturn [msg, {payload: command}];","outputs":"2","noerr":0,"x":398,"y":372,"wires":[["9261a4b7.b360d8"],["c5e22e31.75e75","ab75b9bf.c7ba68"]]},{"id":"9261a4b7.b360d8","type":"http response","z":"5fbe740.7d8188c","name":"","x":610,"y":343,"wires":[]},{"id":"f205ad01.5b5c4","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr/volume/:volume","method":"get","swaggerDoc":"","x":179,"y":336,"wires":[["de348885.5393a8"]]},{"id":"435c522.3078eac","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr/mute/:mute","method":"get","swaggerDoc":"","x":177,"y":373,"wires":[["de348885.5393a8"]]},{"id":"965a66e8.ae62d8","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr/cmd/:cmd","method":"get","swaggerDoc":"","x":194,"y":407,"wires":[["de348885.5393a8"]]},{"id":"e3855f56.55e5e","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr/cmd/:cmd/:param","method":"get","swaggerDoc":"","x":226,"y":436,"wires":[["de348885.5393a8"]]},{"id":"ce1cc812.5403c8","type":"http request","z":"5fbe740.7d8188c","name":"","method":"GET","ret":"txt","url":"http://192.168.0.12:10025","x":547,"y":720,"wires":[["ab75b9bf.c7ba68"]]},{"id":"28741b84.9bce24","type":"template","z":"5fbe740.7d8188c","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<link href=http://getbootstrap.com/dist/css/bootstrap.min.css rel=stylesheet>\n\n<script>\nfunction call(cmd, param) {\n    \n    var r = new XMLHttpRequest(); \n    var url = \"/avr/cmd/\" + cmd;\n    if (param) {\n        url = url + \"/\" + param;\n    }\n    r.open(\"GET\", url, true);\n    r.onreadystatechange = function () {\n    \tif (r.readyState != 4 || r.status != 200) return; \n    \tconsole.log(r.responseText);\n    };\n    r.send();\n    \n}\n</script>\n\n<div class=\"container text-center\">\n\n<br>\n<br>\n\n<div class=\"btn-group\">\n<button class=\"btn btn-default btn-lg\" onclick=\"call('volume-up')\">vol+</button>\n<button class=\"btn btn-default btn-lg\" onclick=\"call('mute-toggle')\">mute+</button>\n<button class=\"btn btn-default btn-lg\" onclick=\"call('volume-down')\">vol-</button>\n</div>\n\n<br>\n<br>\n\n<div class=\"btn-group\">\n<button class=\"btn btn-default btn-lg\" onclick=\"call('source-selection', 'TV')\">TV</button>\n<button class=\"btn btn-default btn-lg\" onclick=\"call('source-selection', 'Audio')\">Chromecast</button>\n</div>\n\n</div>","x":294,"y":130,"wires":[["9261a4b7.b360d8"]]},{"id":"c087435a.976ec","type":"http in","z":"5fbe740.7d8188c","name":"","url":"/avr","method":"get","swaggerDoc":"","x":134,"y":124,"wires":[["28741b84.9bce24"]]}]
```

Allikad:

* https://gist.github.com/tomaszkubacki/8428d1d1c3d86818f534
* http://homematic-forum.de/forum/viewtopic.php?t=18971&p=157793
